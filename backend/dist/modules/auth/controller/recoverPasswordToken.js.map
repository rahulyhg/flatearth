{"version":3,"sources":["../../../../src/modules/auth/controller/recoverPasswordToken.js"],"names":["post","ctx","recoveryToken","password","request","body","user","getCachedDBQuery","find","where","passwordResetToken","passwordResetTokenExpiries","$lt","Date","now","cacheDBQuery","throw","validPassword","api"],"mappings":";;;;;;AAEA;;;;AACA;;;;AACA;;;;;;AAEA;;;;;;;;kBAQe;AACb,QAAMA,IAAN,CAAWC,GAAX,EAAgBC,aAAhB,EAAuC;AACrC,kCAAeD,GAAf,EAAoB,UAApB;;AAEA,UAAM,EAAEE,QAAF,KAAeF,IAAIG,OAAJ,CAAYC,IAAjC;AACA,QAAIC,OAAO,aAAaC,gBAAb,CAA8BL,aAA9B,CAAX;AACA,QAAI,CAACI,IAAL,EAAW;AACTA,aAAO,MAAM,eAAKE,IAAL,CAAU;AACrBC,eAAO;AACLC,8BAAoBR,aADf;AAELS,sCAA4B;AAC1BC,iBAAKC,KAAKC,GAAL;AADqB;AAFvB;AADc,OAAV,CAAb;AAQA,mBAAaC,YAAb,CAA0B,EAAEb,aAAF,EAAiBI,IAAjB,EAA1B;AACD;;AAED,QAAI,CAACA,IAAL,EAAW;AACTL,UAAIe,KAAJ,CAAU,GAAV,EAAe,yCAAf;AACD;;AAED,QAAI,CAACV,KAAKW,aAAL,CAAmBd,QAAnB,CAAL,EAAmC;AACjCF,UAAIe,KAAJ,CAAU,GAAV,EAAe,uBAAf;AACD;AACDf,QAAIiB,GAAJ;AACD;AA1BY,C","file":"recoverPasswordToken.js","sourcesContent":["// @flow\n\nimport User from '../../../models/User';\nimport DBQueryCache from '../../../services/db';\nimport bodyValidation from '../service/bodyValidation';\n\n/*\nROUTE /api/v1/auth/recover-password\n  QUERY POST:\n   - { email: string }\n  ANSWERS:\n   - { status: 'success', token: 'some-token' }\n   - { status: 'error', message: 'some-error' }\n*/\nexport default {\n  async post(ctx, recoveryToken: string) {\n    bodyValidation(ctx, 'password');\n\n    const { password } = ctx.request.body;\n    let user = DBQueryCache.getCachedDBQuery(recoveryToken);\n    if (!user) {\n      user = await User.find({\n        where: {\n          passwordResetToken: recoveryToken,\n          passwordResetTokenExpiries: {\n            $lt: Date.now()\n          }\n        }\n      });\n      DBQueryCache.cacheDBQuery({ recoveryToken, user });\n    }\n\n    if (!user) {\n      ctx.throw(500, 'password is incorrect or token expiried');\n    }\n\n    if (!user.validPassword(password)) {\n      ctx.throw(401, 'password is incorrect');\n    }\n    ctx.api();\n  }\n};\n"]}